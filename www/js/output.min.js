angular.module("starter", [ "ionic", "starter.controllers", "starter.services" ]).directive("fadeBar", function($timeout) {
    return {
        restrict: "E",
        template: '<div class="fade-bar"></div>',
        replace: true,
        link: function($scope, $element, $attr) {
            $timeout(function() {
                $scope.$watch("sideMenuController.getOpenRatio()", function(ratio) {
                    $element[0].style.opacity = Math.abs(ratio);
                });
            });
        }
    };
}).config(function($stateProvider, $urlRouterProvider) {
    $stateProvider.state("tab", {
        url: "/tab",
        "abstract": true,
        templateUrl: "templates/tabs.html",
        controller: "HideCtrl"
    }).state("tab.dash", {
        url: "/dash",
        views: {
            "tab-dash": {
                templateUrl: "templates/tab-dash.html",
                controller: "DashCtrl"
            }
        }
    }).state("tab.factures", {
        url: "/factures",
        views: {
            "tab-factures": {
                templateUrl: "templates/tab-factures.html",
                controller: "FacturesCtrl"
            }
        }
    }).state("tab.factures-ca", {
        url: "/factures-ca",
        views: {
            "tab-factures": {
                templateUrl: "templates/tab-factures-ca.html",
                controller: "FacturesCtrl"
            }
        }
    }).state("tab.factures-tva", {
        url: "/factures-tva",
        views: {
            "tab-factures": {
                templateUrl: "templates/tab-factures-tva.html",
                controller: "FacturesCtrl"
            }
        }
    }).state("tab.factures-charges", {
        url: "/factures-charges",
        views: {
            "tab-factures": {
                templateUrl: "templates/tab-factures-charges.html",
                controller: "FacturesCtrl"
            }
        }
    }).state("tab.facture-detail", {
        url: "/facture/:factureId",
        views: {
            "tab-factures": {
                templateUrl: "templates/facture-detail.html",
                controller: "FactureDetailCtrl"
            }
        }
    }).state("tab.facture-edit", {
        url: "/facture-edit/:factureId",
        views: {
            "tab-factures": {
                templateUrl: "templates/facture-edit.html",
                controller: "FactureEditCtrl"
            }
        }
    });
    $urlRouterProvider.otherwise("/tab/dash");
});

angular.module("starter.controllers", []).controller("ContentController", function($scope, $ionicSideMenuDelegate) {
    $scope.toggleLeft = function() {
        $ionicSideMenuDelegate.toggleLeft();
    };
}).controller("DashCtrl", function($scope, $state) {
    $scope.goto = function(stateName) {
        $state.go(stateName);
    };
}).controller("FacturesCtrl", function($scope, Factures, $state) {
    $scope.factures = Factures.all();
    $scope.goto = function(stateName) {
        $state.go(stateName);
    };
    $scope.data = {
        showDelete: false
    };
    $scope.edit = function(facture) {
        $state.go("tab.facture-edit", {
            factureId: facture.id
        });
    };
    $scope.valid = function(facture) {
        alert("Facture valid√©e !");
    };
    $scope.onItemDelete = function(facture) {
        $scope.factures.splice($scope.factures.indexOf(facture), 1);
    };
}).controller("FactureDetailCtrl", function($scope, $stateParams, Factures, $ionicNavBarDelegate) {
    $scope.facture = Factures.get($stateParams.factureId);
    $scope.goBack = function() {
        $ionicNavBarDelegate.back();
    };
}).controller("FactureEditCtrl", function($scope, $stateParams, Factures, $ionicNavBarDelegate) {
    $scope.facture = Factures.get($stateParams.factureId);
    $scope.goBack = function() {
        $ionicNavBarDelegate.back();
    };
}).controller("HideCtrl", function($scope) {
    console.log("HideCtrl");
    var tabs = document.querySelectorAll("div.tabs")[0];
    tabs = angular.element(tabs);
    tabs.css("display", "none");
    $scope.$on("$destroy", function() {
        console.log("HideCtrl destroy");
        tabs.css("display", "");
    });
});

angular.module("starter.services", []).factory("Factures", function() {
    var factures = [ {
        id: 0,
        name: "Scruff McGruff",
        totalFacture: 1600,
        tva: 20,
        charges: 30,
        payee: 0,
        date: 1400151149
    }, {
        id: 1,
        name: "G.I. Joe",
        totalFacture: 2200,
        tva: 20,
        charges: 30,
        payee: 1,
        date: 1400161149
    }, {
        id: 2,
        name: "Miss Frizzle",
        totalFacture: 4200,
        tva: 20,
        charges: 30,
        payee: 0,
        date: 1400160149
    }, {
        id: 3,
        name: "Ash Ketchum",
        totalFacture: 200,
        tva: 20,
        charges: 30,
        payee: 1,
        date: 1400161049
    } ];
    return {
        all: function() {
            return factures;
        },
        get: function(factureId) {
            return factures[factureId];
        }
    };
});